{% extends 'base.html' %}

{% block title %}
Customers
{% endblock %}


{% block script %}
    <script>
        function update_customer(user_id, fname, lname, email, tags){
            console.log(user_id);
            $('#modal_user_id').val(user_id.slice(user_id.lastIndexOf('/')+1));
            $('#modal_first_name').val(fname);
            $('#modal_last_name').val(lname);
            $('#modal_email').val(email);
            $('#modal_tags').val([... tags])
        }
        function save_user_data(){
            $.ajax({
                url: '/update_customer/',
                type: 'POST',
                dataType: 'json',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}', 
                    user_id: $("#modal_user_id").val(),
                    first_name: $("#modal_first_name").val(),
                    last_name: $("#modal_last_name").val(),
                    email: $("#modal_email").val(),
                    tags: $("#modal_tags").val()
                },
                success: function(data) {
                    console.log(data);
                    if(data=='422')
                    alert('Customer modification failed, invalid data entered');
                    else if(data=='200')
                    alert('Customer modified');
                }
            });
        }
        $(document).ready(function(){
            $('#dt').DataTable();
        });
    </script>
{% endblock %}

{% block container %}
    <table id="dt" class="table table-striped table-bordered" style="width:100%">
        <thead>
            <th>
                <tr>
                    <th>Name</th>
                    <th>Email Address</th>
                    <th>Orders</th>
                    <th>Actions</th>
                </tr>
            </th>
        </thead>
        <tbody id="table_body">
        {% for row in data %}
            <tr>
                <td>{{row.node.firstName}} {{row.node.lastName}}</td>
                <td>{{row.node.email}}</td>
                <td>{{row.node.ordersCount}}</td>
                <td><button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModal" 
                onclick="update_customer('{{row.node.id|safe}}','{{row.node.firstName|safe}}','{{row.node.lastName|safe}}','{{row.node.email|safe}}',{{row.node.tags|safe}})">Update Customer</button></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-body">
                <input type="hidden" name="modal_user_id" id="modal_user_id" val="">
                  First Name: <input type="text" class="form-control" id="modal_first_name"><br>
                  Last Name: <input type="text" class="form-control" id="modal_last_name"><br>
                  Email: <input type="email" class="form-control" id="modal_email"><br>
                  Tags: <input type="text" class="form-control" id="modal_tags"><br>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" onclick="save_user_data()" data-dismiss="modal">Save</button>
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </div>
          </div>
      
        </div>
      </div>
{% endblock %}